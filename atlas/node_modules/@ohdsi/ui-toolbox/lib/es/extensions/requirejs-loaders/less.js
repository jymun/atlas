'use strict';

define(['appConfig'], function factory() {
  return {
    appendLink: function appendLink(url) {
      if (typeof document !== 'undefined') {
        // for requirejs optimizer
        var head = document.getElementsByTagName('head')[0];

        var link = document.createElement('link');
        link.rel = 'stylesheet/less';
        link.type = 'text/css';
        link.href = url;
        head.appendChild(link);

        return link;
      }
    },
    appendText: function appendText(compiledCss) {
      var head = document.querySelector('head');
      var style = document.createElement('style');
      style.type = 'text/css';
      style.textContent = compiledCss;
      head.appendChild(style);
    },

    load: function load(name, req, onload, _config) {
      var _this = this;

      req(['less-js'], function () {
        var link = _this.appendLink(req.toUrl(name));
        window.less.sheets.push(link);
        window.less.refresh();
        window.less.options.logLevel = 0;
        onload();
      });
    },
    write: function write(pluginName, moduleName, writer) {
      var _this2 = this;

      var fs = require.nodeRequire('fs');
      var lessJs = require.nodeRequire('less');
      var rawLess = fs.readFileSync(require.toUrl(moduleName)).toString();
      lessJs.render(rawLess, null, function (a, _ref) {
        var css = _ref.css;

        writer('\n          define(\'' + pluginName + '!' + moduleName + '\', () => {\n            (' + _this2.appendText.toString() + ')(`\n              ' + css + '\n            `)\n          })\n        ');
      });
    }
  };
});